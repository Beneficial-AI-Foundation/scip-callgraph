# Metrics Pipeline

Complete pipeline for computing complexity metrics for Verus-verified Rust code.

## Overview

```
SCIP Index â†’ Atoms JSON â†’ Spec Metrics â†’ Proof Metrics â†’ Enriched CSV
                â†‘
        RCA JSONs (code metrics)
```

## Prerequisites

1. **SCIP Index** generated from Verus source code
2. **RCA JSONs** generated by `rust-code-analysis-cli` on vanilla source

### Generate RCA JSONs (one-time)
```bash
# From rust-code-analysis repo
./target/debug/rust-code-analysis-cli -m -p /path/to/vanilla/curve25519-dalek/ -O json -o /path/to/output/
```

---

## Pipeline Steps

### Step 1: Generate Atoms JSON from SCIP

Extracts function names, bodies, and dependencies from SCIP index.

```bash
cargo run -p metrics-cli --bin write_atoms -- <input_scip_json> <output_atoms_json>
```

**Example:**
```bash
cargo run -p metrics-cli --bin write_atoms -- \
  curve_dalek_index_scip_26_nov.json \
  curve_dalek_atoms.json
```

**Output:** JSON with entries like:
```json
{
  "identifier": "...",
  "display_name": "add",
  "relative_path": "src/backend/serial/u64/field.rs",
  "body": "fn add(...) { ... }",
  "deps": [...]
}
```

---

### Step 2: Compute Verus-Specific Metrics (Specs)

Parses Verus specifications and computes Halstead metrics for each clause.

```bash
cargo run -p metrics-cli --bin compute_metrics -- <input_atoms_json> <output_metrics_json>
```

**Example:**
```bash
cargo run -p metrics-cli --bin compute_metrics -- \
  curve_dalek_atoms.json \
  curve_dalek_atoms_with_metrics.json
```

**Adds:**
- `requires_count`, `requires_lengths`, `requires_specs` (Halstead for each)
- `ensures_count`, `ensures_lengths`, `ensures_specs` (Halstead for each)
- `decreases_count`, `decreases_specs` (Halstead for each)
- `body_length`, `operators` (count by type)

---

### Step 3: Compute Proof Metrics (with Transitive Dependencies)

Extracts `proof { }` blocks and computes Halstead metrics, including transitive lemma calls.

```bash
cargo run -p metrics-cli --bin compute_proof_metrics -- <input_metrics_json> <output_complete_json>
```

**Example:**
```bash
cargo run -p metrics-cli --bin compute_proof_metrics -- \
  curve_dalek_atoms_with_metrics.json \
  curve_dalek_atoms_complete.json
```

**Adds:**
- `direct_proof_halstead` (n1, N1, n2, N2, length, difficulty, effort)
- `transitive_proof_halstead` (includes all called lemmas)
- `direct_lemmas`, `transitive_lemmas` (list of lemma names)
- `proof_depth` (max call depth)

---

### Step 4: Enrich CSV with Code Metrics (from RCA)

Adds implementation complexity metrics from `rust-code-analysis` JSONs.

```bash
cargo run -p metrics-cli --bin enrich_csv_with_metrics -- \
  <input_csv> \
  <rca_json_directory> \
  <output_csv>
```

**Example:**
```bash
cargo run -p metrics-cli --bin enrich_csv_with_metrics -- \
  functions_to_track.csv \
  curve25519-dalek/curve25519-dalek/ \
  functions_to_track_enriched.csv
```

**Adds columns:**
- `cyclomatic` - McCabe's cyclomatic complexity
- `cognitive` - SonarSource cognitive complexity
- `halstead_length` - Total tokens (implementation size)
- `halstead_difficulty` - Code density
- `halstead_effort` - Mental effort required

---

### Step 5: Enrich CSV with Spec + Proof Metrics

Adds all specification and proof Halstead metrics to the CSV.

```bash
cargo run -p metrics-cli --bin enrich_csv_complete -- \
  <complete_json> \
  <enriched_csv> \
  <output_csv>
```

**Example:**
```bash
cargo run -p metrics-cli --bin enrich_csv_complete -- \
  curve_dalek_atoms_complete.json \
  functions_to_track_enriched.csv \
  functions_to_track_COMPLETE.csv
```

**Adds columns:**
- `requires_halstead_length/difficulty/effort`
- `ensures_halstead_length/difficulty/effort`
- `decreases_count`
- `direct_proof_length/difficulty/effort`
- `transitive_proof_length/difficulty/effort`
- `proof_depth`
- `direct_lemmas_count`, `transitive_lemmas_count`

---

## Full Pipeline (Copy-Paste Ready)

```bash
cd /home/lacra/git_repos/baif/scip-callgraph

# Step 1: Generate atoms from SCIP
cargo run -p metrics-cli --bin write_atoms -- \
  data/scip/curve_dalek_index_scip_26_nov.json \
  data/atoms/curve_dalek_atoms.json

# Step 2: Compute spec metrics
cargo run -p metrics-cli --bin compute_metrics -- \
  data/atoms/curve_dalek_atoms.json \
  data/atoms/curve_dalek_atoms_with_metrics.json

# Step 3: Compute proof metrics
cargo run -p metrics-cli --bin compute_proof_metrics -- \
  data/atoms/curve_dalek_atoms_with_metrics.json \
  data/atoms/curve_dalek_atoms_complete.json

# Step 4: Enrich CSV with code metrics (from RCA)
cargo run -p metrics-cli --bin enrich_csv_with_metrics -- \
  data/csv/functions_to_track.csv \
  curve25519-dalek/curve25519-dalek/ \
  data/csv/functions_to_track_enriched.csv

# Step 5: Enrich CSV with spec + proof metrics
cargo run -p metrics-cli --bin enrich_csv_complete -- \
  data/atoms/curve_dalek_atoms_complete.json \
  data/csv/functions_to_track_enriched.csv \
  data/csv/functions_to_track_COMPLETE.csv
```

---

## ðŸš€ Automated Pipeline Runner

Run the **entire pipeline with a single command** using `run_full_pipeline`:

```bash
cargo run -p metrics-cli --bin run_full_pipeline -- \
  --scip data/scip/curve_dalek_index_scip_26_nov.json \
  --csv data/csv/functions_to_track.csv \
  --rca-dir curve25519-dalek/curve25519-dalek/ \
  --proof-csv data/csv/curve25519_functions_with_trivial.csv \
  --output-dir data/pipeline_output
```

### Arguments

| Argument | Description |
|----------|-------------|
| `--scip` | Path to SCIP index JSON file |
| `--csv` | Path to `functions_to_track.csv` |
| `--rca-dir` | Directory containing `rust-code-analysis` JSONs |
| `--proof-csv` | CSV with `has_proof`/`trivial_proof` columns |
| `--output-dir` | Output directory (default: `data/pipeline_output`) |

### Output Structure

```
data/pipeline_output/
â”œâ”€â”€ step1_atoms.json          # 995 functions from SCIP
â”œâ”€â”€ step2_with_specs.json     # + spec Halstead metrics
â”œâ”€â”€ step3_with_proofs.json    # + proof Halstead metrics  
â”œâ”€â”€ step4_with_code.csv       # + RCA code metrics
â””â”€â”€ FINAL.csv                 # Complete: 212 rows Ã— 25 columns
```

### Performance

| Step | Time |
|------|------|
| 1. Generate atoms | ~3s |
| 2. Spec metrics | ~0.6s |
| 3. Proof metrics | ~13s |
| 4. RCA enrichment | ~0.05s |
| 5. Final enrichment | ~0.7s |
| **Total** | **~17s** |

### Features

- âœ… Creates output directory automatically
- âœ… Runs all 5 steps in sequence
- âœ… Shows progress and statistics at each step
- âœ… Reports final CSV dimensions
- âœ… Produces intermediate files for debugging

---

## Output Files

| File | Description |
|------|-------------|
| `curve_dalek_atoms.json` | Raw atoms (functions, bodies, deps) |
| `curve_dalek_atoms_with_metrics.json` | + spec Halstead metrics |
| `curve_dalek_atoms_complete.json` | + proof Halstead metrics |
| `functions_to_track_enriched.csv` | CSV + code metrics (RCA) |
| `functions_to_track_COMPLETE.csv` | CSV + code + spec + proof metrics |

---

## Scripts Summary

### Pipeline Runner
| Script | Purpose |
|--------|---------|
| `run_full_pipeline` | **Runs entire pipeline with one command** (~17s) |

### Metrics Computation
| Script | Input | Output | Purpose |
|--------|-------|--------|---------|
| `write_atoms` | SCIP JSON | Atoms JSON | Extract functions from SCIP |
| `compute_metrics` | Atoms JSON | Metrics JSON | Spec Halstead metrics |
| `compute_proof_metrics` | Metrics JSON | Complete JSON | Proof Halstead metrics |

### CSV Enrichment
| Script | Adds | Source |
|--------|------|--------|
| `enrich_csv_with_metrics` | Code Halstead (cyclomatic, cognitive, etc.) | RCA JSONs |
| `enrich_csv_with_spec_metrics` | Spec Halstead | Metrics JSON |
| `enrich_csv_with_proof_metrics` | Proof Halstead | Complete JSON |
| `enrich_csv_complete` | All spec + proof metrics | Complete JSON |

### Utilities
| Script | Purpose |
|--------|---------|
| `verify_rca_coverage` | Regression test: RCA functions in atoms |
| `categorize_verified_functions` | Classify by verification type |
| `find_untracked_verified` | Find verified functions not in CSV |

---

## Notes

- **RCA metrics** are computed on **vanilla** source (no Verus proofs)
- **Spec/Proof metrics** are computed on **Verus** source (with proofs)
- `proof_overhead = body_length (Verus) - halstead_length (vanilla)`

