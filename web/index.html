<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SCIP Call Graph Viewer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <h1>ğŸ“Š SCIP Call Graph Viewer</h1>
      <div class="file-input-container">
        <label for="file-input" class="file-input-label">
          ğŸ“ Load Graph JSON
        </label>
        <input type="file" id="file-input" accept=".json" />
      </div>
    </header>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Sidebar - Controls -->
      <aside class="sidebar sidebar-left">
        <section class="panel">
          <h2>ğŸ›ï¸ Filters</h2>
          
          <div class="filter-group">
            <h3>Source Type</h3>
            <label class="checkbox-label">
              <input type="checkbox" id="show-libsignal" checked />
              <span class="libsignal-badge">Libsignal</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="show-non-libsignal" checked />
              <span class="other-badge">External</span>
            </label>
          </div>

          <div class="filter-group">
            <h3>Call Types</h3>
            <label class="checkbox-label">
              <input type="checkbox" id="show-inner-calls" checked />
              <span class="inner-badge">Body Calls</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="show-precondition-calls" />
              <span class="precondition-badge">Requires</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="show-postcondition-calls" />
              <span class="postcondition-badge">Ensures</span>
            </label>
            <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 0.25rem;">
              ğŸ’¡ Show/hide dependencies from pre/postconditions
            </small>
          </div>

          <div class="filter-group">
            <h3>Function Mode</h3>
            <label class="checkbox-label">
              <input type="checkbox" id="show-exec-functions" checked />
              <span class="exec-badge">Exec</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="show-proof-functions" checked />
              <span class="proof-badge">Proof</span>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="show-spec-functions" />
              <span class="spec-badge">Spec</span>
            </label>
            <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 0.25rem;">
              ğŸ’¡ Verus function modes (spec off by default)
            </small>
          </div>

          <div class="filter-group">
            <h3>ğŸš« Exclude by Name</h3>
            <label class="input-label">
              <input 
                type="text" 
                id="exclude-name-patterns" 
                placeholder="e.g., *_comm*, lemma_mul_*" 
                class="search-input"
              />
            </label>
            <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 0.25rem;">
              ğŸ’¡ Matches function names. <code>*_comm*</code> excludes <code>lemma_commutativity</code>
            </small>
          </div>

          <div class="filter-group">
            <h3>ğŸ“‚ Exclude by Path</h3>
            <div class="preset-row">
              <select id="exclude-path-presets" class="preset-select">
                <option value="">+ Add preset...</option>
                <option value="*/specs/*">specs/</option>
                <option value="*/common_lemmas/*">common_lemmas/</option>
                <option value="*/specs/*, */common_lemmas/*">specs + common</option>
              </select>
            </div>
            <label class="input-label">
              <input 
                type="text" 
                id="exclude-path-patterns" 
                placeholder="e.g., */specs/*, */common_lemmas/*" 
                class="search-input"
              />
            </label>
            <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 0.25rem;">
              ğŸ’¡ Matches node paths. <code>*/specs/*</code> excludes all spec functions
            </small>
          </div>

          <div class="filter-group">
            <h3>ğŸ“ Include Files</h3>
            <div class="input-with-dropdown">
              <label class="input-label">
                <input 
                  type="text" 
                  id="include-files" 
                  placeholder="e.g., edwards.rs, decompress*.rs" 
                  class="search-input"
                />
              </label>
              <div id="file-disambiguation-dropdown" class="disambiguation-dropdown" style="display: none;">
                <!-- Populated dynamically when ambiguous filename is detected -->
              </div>
            </div>
            <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 0.25rem;">
              ğŸ’¡ Empty = all files. Use path like <code>ifma/edwards.rs</code> to disambiguate
            </small>
            <details class="file-list-details">
              <summary>ğŸ“‹ Available files (<span id="file-count">0</span>)</summary>
              <div id="file-list" class="file-list">
                <!-- Populated dynamically -->
              </div>
            </details>
          </div>

          <div class="filter-group">
            <h3>ğŸ” Source â†’ Sink</h3>
            <label class="input-label">
              <span>Source (shows callees):</span>
              <input 
                type="text" 
                id="source-input" 
                placeholder="e.g., main, parse_config..." 
                class="search-input"
              />
            </label>
            <label class="input-label">
              <span>Sink (shows callers):</span>
              <input 
                type="text" 
                id="sink-input" 
                placeholder="e.g., to_bytes, validate..." 
                class="search-input"
              />
            </label>
            <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 0.5rem;">
              ğŸ’¡ <strong>Source only:</strong> what it calls<br>
              ğŸ’¡ <strong>Sink only:</strong> who calls it<br>
              ğŸ’¡ <strong>Both:</strong> paths between them<br>
              ğŸ’¡ Glob: <code>decompress</code> = exact, <code>*decomp*</code> = contains<br>
              ğŸ’¡ Rust-style: <code>edwards::decompress</code> (file::func)
            </small>
          </div>

          <div class="filter-group">
            <h3>Depth</h3>
            <label class="slider-label">
              <span>Depth: <strong id="depth-value">1</strong></span>
              <input 
                type="range" 
                id="depth-limit" 
                min="0" 
                max="10" 
                value="1" 
                class="slider"
              />
              <small>How many hops from source/sink to show. 0 = all</small>
            </label>
          </div>

          <div class="button-group">
            <button id="reset-filters" class="btn btn-secondary">
              ğŸ”„ Reset Filters
            </button>
            <button id="clear-selection" class="btn btn-secondary">
              âŒ Clear Selection
            </button>
            <button id="copy-link" class="btn btn-primary">
              ğŸ”— Copy Link
            </button>
          </div>

          <div id="hidden-nodes-container" class="filter-group" style="display: none;">
            <h3>ğŸ‘ï¸ Hidden Nodes (<span id="hidden-count">0</span>)</h3>
            <ul id="hidden-nodes-list" class="hidden-nodes-list"></ul>
            <button id="show-all-hidden" class="btn btn-secondary" style="margin-top: 0.5rem;">
              ğŸ‘ï¸ Show All
            </button>
            <small style="color: #666; font-size: 0.75rem; display: block; margin-top: 0.25rem;">
              ğŸ’¡ Shift+click to hide nodes
            </small>
          </div>
        </section>

        <section class="panel">
          <h2>ğŸ“ˆ Statistics</h2>
          <div id="stats" class="stats-container">
            <p>No graph loaded.</p>
            <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
              ğŸ’¡ You can also load via URL:<br>
              <code style="font-size: 0.75rem;">?json=https://url-to-graph.json</code>
            </p>
          </div>
        </section>

        <section class="panel">
          <h2>ğŸ¨ Verification Legend</h2>
          <div class="legend-container">
            <div class="legend-item">
              <span class="legend-dot" style="background: #22c55e;"></span>
              <span>Verified</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot" style="background: #ef4444;"></span>
              <span>Failed</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot" style="background: #9ca3af;"></span>
              <span>Unverified</span>
            </div>
            <div class="legend-item">
              <span class="legend-dot" style="background: #3b82f6;"></span>
              <span>Unknown</span>
            </div>
          </div>
        </section>
      </aside>

      <!-- Center - Graph Visualization -->
      <main class="graph-section">
        <div id="graph-container" class="graph-container">
          <!-- D3 visualization will be rendered here -->
        </div>
        <div class="graph-instructions">
          <p><strong>ğŸ’¡ Instructions:</strong></p>
          <ul>
            <li><strong>Zoom:</strong> Scroll or pinch</li>
            <li><strong>Pan:</strong> Click and drag background</li>
            <li><strong>Move Node:</strong> Drag a node</li>
            <li><strong>Select:</strong> Click a node to see details</li>
            <li><strong>Hide:</strong> Shift+click a node</li>
            <li><strong>Source/Sink:</strong> Enter function names to explore call paths</li>
          </ul>
        </div>
      </main>

      <!-- Right Sidebar - Node Info -->
      <aside class="sidebar sidebar-right">
        <section class="panel">
          <h2>â„¹ï¸ Node Details</h2>
          <div id="node-info" class="node-info">
            <p class="placeholder">Click or hover over a node to see details</p>
          </div>
        </section>
      </aside>
    </div>

    <!-- Footer -->
    <footer class="footer">
      <p>
        Built with <a href="https://d3js.org/" target="_blank">D3.js</a> | 
        <a href="https://github.com/Beneficial-AI-Foundation/scip-callgraph" target="_blank">GitHub</a>
      </p>
    </footer>
  </div>

  <script type="module" src="/src/main.ts"></script>
</body>
</html>

